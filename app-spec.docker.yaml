# DigitalOcean App Platform Specification for OpenGRC Docker
# This replaces your existing buildpack-based deployment with a Docker container
# Running Ubuntu 24.04 with Apache2 and TLS 1.3+

name: opengrc-docker
region: nyc

# Alerts configuration
alerts:
  - rule: DEPLOYMENT_FAILED
  - rule: DOMAIN_FAILED

# Domain configuration
domains:
  - domain: your-domain.opengrc.net
    type: PRIMARY

# VPC configuration (use your existing VPC)
vpc:
  id: 3d50ead9-c390-4024-a3a0-6f5a63171a66

# Service configuration
services:
  - name: opengrc
    # Use Dockerfile instead of buildpack
    dockerfile_path: Dockerfile

    # GitHub source
    github:
      repo: LeeMangold/OpenGRC
      branch: main
      deploy_on_push: true

    # Container runs on port 443 (HTTPS with TLS 1.3+)
    http_port: 443

    # Instance configuration
    instance_count: 1
    instance_size_slug: apps-s-1vcpu-1gb-fixed

    # Health check (HTTPS)
    health_check:
      http_path: /
      initial_delay_seconds: 60
      period_seconds: 30
      timeout_seconds: 5
      success_threshold: 1
      failure_threshold: 3

    # Resource alerts
    alerts:
      - operator: GREATER_THAN
        rule: CPU_UTILIZATION
        value: 75
        window: FIVE_MINUTES
      - operator: GREATER_THAN
        rule: MEM_UTILIZATION
        value: 75
        window: FIVE_MINUTES

    # Logging (OpenSearch)
    log_destinations:
      - name: OpenGRC Log Collector
        open_search:
          basic_auth:
            user: doadmin
          cluster_name: og-search-1
          index_name: logs

    # Environment Variables
    envs:
      # ===========================================
      # Database Configuration (MySQL with SSL)
      # ===========================================
      - key: DB_CONNECTION
        scope: RUN_TIME
        value: mysql

      - key: DB_HOST
        scope: RUN_TIME
        value: private-opengrc-nyc1-a-do-user-25765278-0.g.db.ondigitalocean.com

      - key: DB_PORT
        scope: RUN_TIME
        value: "25060"

      - key: DB_DATABASE
        scope: RUN_TIME
        value: og_internal

      - key: DB_USERNAME
        scope: RUN_TIME
        value: og_internal

      - key: DB_PASSWORD
        scope: RUN_TIME
        type: SECRET
        value: YOUR_DB_PASSWORD_HERE

      - key: DB_SSL_MODE
        scope: RUN_TIME
        value: require

      # ===========================================
      # Application Configuration
      # ===========================================
      - key: APP_KEY
        scope: RUN_TIME
        type: SECRET
        value: YOUR_APP_KEY_HERE

      - key: APP_NAME
        scope: RUN_TIME
        value: OpenGRC - Internal

      - key: APP_URL
        scope: RUN_TIME
        value: https://your-domain.opengrc.net

      - key: APP_ENV
        scope: RUN_TIME
        value: production

      - key: APP_DEBUG
        scope: RUN_TIME
        value: "false"

      # ===========================================
      # Admin User Configuration
      # ===========================================
      - key: ADMIN_EMAIL
        scope: RUN_TIME
        value: admin@opengrc.net

      - key: ADMIN_PASSWORD
        scope: RUN_TIME
        type: SECRET
        value: YOUR_ADMIN_PASSWORD_HERE

      # ===========================================
      # DigitalOcean Spaces Storage
      # ===========================================
      - key: DO_BUCKET
        scope: RUN_TIME
        value: og-vsgzz-internal

      - key: DO_REGION
        scope: RUN_TIME
        value: nyc3

      - key: DO_ACCESS_KEY_ID
        scope: RUN_TIME
        value: DO009BD9BTQF3D3CB4EE

      - key: DO_SECRET_ACCESS_KEY
        scope: RUN_TIME
        type: SECRET
        value: YOUR_DO_SECRET_HERE

      # ===========================================
      # SMTP Configuration (AWS SES)
      # ===========================================
      - key: SMTP_HOST
        scope: RUN_TIME
        value: email-smtp.us-east-1.amazonaws.com

      - key: SMTP_PORT
        scope: RUN_TIME
        value: "465"

      - key: SMTP_USER
        scope: RUN_TIME
        value: AKIAVUBDF4DRSLNDLD6E

      - key: SMTP_PASSWORD
        scope: RUN_TIME
        type: SECRET
        value: YOUR_SMTP_PASSWORD_HERE

      - key: SMTP_ENCRYPTION
        scope: RUN_TIME
        value: tls

      - key: SMTP_FROM
        scope: RUN_TIME
        value: no-reply@opengrc.net

      # ===========================================
      # Storage Lock (Prevent UI Changes)
      # ===========================================
      - key: STORAGE_LOCK
        scope: RUN_TIME
        value: "true"

      # ===========================================
      # Node Environment
      # ===========================================
      - key: NODE_ENV
        scope: RUN_AND_BUILD_TIME
        value: production
